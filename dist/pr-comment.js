"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.NO_SUGGESTIONS_INTRO = exports.SUGGESTIONS_INTRO = void 0;
exports.formatComment = formatComment;
exports.postComment = postComment;
const core = __importStar(require("@actions/core"));
const github = __importStar(require("@actions/github"));
exports.SUGGESTIONS_INTRO = 'Thanks for the PR! Here are a few doc tweaks to improve integration and platform understanding for customers.';
exports.NO_SUGGESTIONS_INTRO = "Thanks for the PR! I looked over the changes and didn't spot any doc updates needed to help customers integrate or understand the platform.";
/**
 * Format suggestions as markdown comment
 */
function formatComment(response) {
    if (response.impact_level === 'none' || response.suggestions.length === 0) {
        return `## ðŸ“š Documentation Check-In

${response.comment_intro?.trim() || exports.NO_SUGGESTIONS_INTRO}

${response.summary}

Want me to focus on something specific next time? Add a \`prompt_instruction\` input to the workflow and I'll tailor the review.`;
    }
    const severityEmoji = {
        info: 'â„¹ï¸',
        warning: 'âš ï¸',
        critical: 'ðŸš¨'
    };
    const suggestionBlocks = response.suggestions.map((s, i) => {
        const emoji = severityEmoji[s.severity];
        const lineInfo = s.start_line && s.end_line
            ? ` (lines ${s.start_line}-${s.end_line})`
            : '';
        return `### ${emoji} Suggestion ${i + 1}: ${s.type} \`${s.target_file}\`${lineInfo}

**Focus**: ${s.target_section}
**Why this helps**: ${s.rationale}

<details>
<summary>Suggested wording</summary>

\`\`\`markdown
${s.suggested_text}
\`\`\`

</details>`;
    }).join('\n\n');
    return `## ðŸ“š Documentation Check-In

${response.comment_intro?.trim() || exports.SUGGESTIONS_INTRO}

**Impact**: ${response.impact_level.toUpperCase()} | **Suggestions**: ${response.suggestions.length}

${suggestionBlocks}

---

Want me to lean into a particular style or audience? Add a \`prompt_instruction\` input in the workflow and I'll follow it on the next run.

<sub>ðŸ¤– Generated by [Soyio Docs Bot](https://github.com/soyio/soyio-docs-bot)</sub>`;
}
/**
 * Post comment to PR
 */
async function postComment(token, owner, repo, prNumber, comment) {
    const octokit = github.getOctokit(token);
    // Check if bot already commented
    const { data: comments } = await octokit.rest.issues.listComments({
        owner,
        repo,
        issue_number: prNumber
    });
    const botComment = comments.find(c => c.body?.includes('ðŸ“š Documentation Check-In') ||
        c.body?.includes('Documentation Update Suggestions') ||
        c.body?.includes('Documentation Analysis'));
    if (botComment) {
        // Update existing comment
        await octokit.rest.issues.updateComment({
            owner,
            repo,
            comment_id: botComment.id,
            body: comment
        });
        core.info('Updated existing comment');
    }
    else {
        // Create new comment
        await octokit.rest.issues.createComment({
            owner,
            repo,
            issue_number: prNumber,
            body: comment
        });
        core.info('Posted new comment');
    }
}
